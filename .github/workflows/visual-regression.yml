name: Visual Regression

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      deployments: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install Playwright Chromium
        run: yarn playwright install --with-deps chromium

      - name: Resolve Vercel preview URL from Deployment API
        id: resolve-preview
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            const timeoutMs = 5 * 60 * 1000;
            const intervalMs = 10 * 1000;
            const startedAt = Date.now();
            let previewUrl = '';

            while (Date.now() - startedAt < timeoutMs) {
              const deployments = await github.paginate(github.rest.repos.listDeployments, {
                owner,
                repo,
                sha,
                per_page: 100,
              });

              for (const deployment of deployments) {
                const statuses = await github.paginate(github.rest.repos.listDeploymentStatuses, {
                  owner,
                  repo,
                  deployment_id: deployment.id,
                  per_page: 100,
                });

                const successStatus = statuses.find(status => {
                  if (status.state !== 'success') {
                    return false;
                  }
                  const url = status.environment_url || status.target_url || '';
                  return url.includes('vercel.app');
                });

                if (successStatus) {
                  previewUrl = (successStatus.environment_url || successStatus.target_url || '').replace(/\/$/, '');
                  break;
                }
              }

              if (previewUrl) {
                break;
              }

              core.info('Vercel preview deployment is not ready yet. Waiting 10 seconds...');
              await new Promise(resolve => setTimeout(resolve, intervalMs));
            }

            if (!previewUrl) {
              core.setFailed('Could not resolve Vercel preview URL from GitHub Deployment API within 5 minutes.');
              return;
            }

            core.info(`Resolved preview URL: ${previewUrl}`);
            core.setOutput('preview_url', previewUrl);

      - name: Run visual regression tests
        env:
          VERCEL_PREVIEW_URL: ${{ steps.resolve-preview.outputs.preview_url }}
        run: yarn test:visual tests/visual-regression

      - name: Upload visual diff artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-artifacts
          path: |
            test-results
            playwright-report
          if-no-files-found: ignore
          retention-days: 14
